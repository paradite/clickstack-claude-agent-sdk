name: clickstack

services:
  # MongoDB - Application state storage (dashboards, alerts, users)
  db:
    image: mongo:5.0.32-focal
    volumes:
      - ~/.clickstack/mongo:/data/db
    networks:
      - clickstack
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ClickHouse - Telemetry data storage
  ch-server:
    image: clickhouse/clickhouse-server:25.6-alpine
    environment:
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - ./clickhouse/config.xml:/etc/clickhouse-server/config.xml
      - ./clickhouse/users.xml:/etc/clickhouse-server/users.xml
      - ~/.clickstack/clickhouse/data:/var/lib/clickhouse
      - ~/.clickstack/clickhouse/logs:/var/log/clickhouse-server
    ports:
      - "8123:8123"  # HTTP API (for Telescope/external access)
      # - "9000:9000"  # Native TCP (uncomment if needed)
    networks:
      - clickstack
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # OpenTelemetry Collector - Data ingestion
  otel-collector:
    image: docker.clickhouse.com/clickhouse/clickstack-otel-collector:${IMAGE_VERSION}
    environment:
      CLICKHOUSE_ENDPOINT: "tcp://ch-server:9000?dial_timeout=10s"
      HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE: ${HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE}
      HYPERDX_LOG_LEVEL: ${HYPERDX_LOG_LEVEL}
      OPAMP_SERVER_URL: "http://app:${HYPERDX_OPAMP_PORT}"
      # Enable custom config to wire OTLP receivers to pipelines
      CUSTOM_OTELCOL_CONFIG_FILE: /etc/otel-custom/custom-config.yaml
    volumes:
      - ./otel-collector/custom-config.yaml:/etc/otel-custom/custom-config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "13133:13133" # Health check
      - "8888:8888"   # Metrics
      - "24225:24225" # Fluentd
    networks:
      - clickstack
    depends_on:
      ch-server:
        condition: service_healthy
    restart: always

  # HyperDX App - Web UI and API
  app:
    image: docker.hyperdx.io/hyperdx/hyperdx:${IMAGE_VERSION}
    environment:
      FRONTEND_URL: "${HYPERDX_APP_URL}:${HYPERDX_APP_PORT}"
      HYPERDX_API_PORT: ${HYPERDX_API_PORT}
      HYPERDX_APP_PORT: ${HYPERDX_APP_PORT}
      HYPERDX_APP_URL: ${HYPERDX_APP_URL}
      HYPERDX_LOG_LEVEL: ${HYPERDX_LOG_LEVEL}
      MONGO_URI: "mongodb://db:27017/hyperdx"
      SERVER_URL: "http://127.0.0.1:${HYPERDX_API_PORT}"
      OPAMP_PORT: ${HYPERDX_OPAMP_PORT}
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_SERVICE_NAME: "hdx-oss-app"
      DEFAULT_CONNECTIONS: '[{"name":"Local ClickHouse","host":"http://ch-server:8123","username":"default","password":""}]'
      DEFAULT_SOURCES: >-
        [
          {
            "from":{"databaseName":"default","tableName":"otel_logs"},
            "kind":"log",
            "timestampValueExpression":"TimestampTime",
            "name":"Logs",
            "displayedTimestampValueExpression":"Timestamp",
            "implicitColumnExpression":"Body",
            "serviceNameExpression":"ServiceName",
            "bodyExpression":"Body",
            "eventAttributesExpression":"LogAttributes",
            "resourceAttributesExpression":"ResourceAttributes",
            "defaultTableSelectExpression":"Timestamp,ServiceName,SeverityText,Body",
            "severityTextExpression":"SeverityText",
            "traceIdExpression":"TraceId",
            "spanIdExpression":"SpanId",
            "connection":"Local ClickHouse",
            "traceSourceId":"Traces",
            "sessionSourceId":"Sessions",
            "metricSourceId":"Metrics"
          },
          {
            "from":{"databaseName":"default","tableName":"otel_traces"},
            "kind":"trace",
            "timestampValueExpression":"Timestamp",
            "name":"Traces",
            "displayedTimestampValueExpression":"Timestamp",
            "implicitColumnExpression":"SpanName",
            "serviceNameExpression":"ServiceName",
            "bodyExpression":"SpanName",
            "eventAttributesExpression":"SpanAttributes",
            "resourceAttributesExpression":"ResourceAttributes",
            "defaultTableSelectExpression":"Timestamp,ServiceName,StatusCode,round(Duration/1e6),SpanName",
            "traceIdExpression":"TraceId",
            "spanIdExpression":"SpanId",
            "durationExpression":"Duration",
            "durationPrecision":9,
            "parentSpanIdExpression":"ParentSpanId",
            "spanNameExpression":"SpanName",
            "spanKindExpression":"SpanKind",
            "statusCodeExpression":"StatusCode",
            "statusMessageExpression":"StatusMessage",
            "connection":"Local ClickHouse",
            "logSourceId":"Logs",
            "sessionSourceId":"Sessions",
            "metricSourceId":"Metrics"
          },
          {
            "from":{"databaseName":"default","tableName":""},
            "kind":"metric",
            "timestampValueExpression":"TimeUnix",
            "name":"Metrics",
            "resourceAttributesExpression":"ResourceAttributes",
            "metricTables":{
              "gauge":"otel_metrics_gauge",
              "histogram":"otel_metrics_histogram",
              "sum":"otel_metrics_sum"
            },
            "connection":"Local ClickHouse",
            "logSourceId":"Logs",
            "traceSourceId":"Traces",
            "sessionSourceId":"Sessions"
          },
          {
            "from":{"databaseName":"default","tableName":"hyperdx_sessions"},
            "kind":"session",
            "timestampValueExpression":"TimestampTime",
            "name":"Sessions",
            "displayedTimestampValueExpression":"Timestamp",
            "implicitColumnExpression":"Body",
            "serviceNameExpression":"ServiceName",
            "bodyExpression":"Body",
            "eventAttributesExpression":"LogAttributes",
            "resourceAttributesExpression":"ResourceAttributes",
            "defaultTableSelectExpression":"Timestamp,ServiceName,SeverityText,Body",
            "severityTextExpression":"SeverityText",
            "traceIdExpression":"TraceId",
            "spanIdExpression":"SpanId",
            "connection":"Local ClickHouse",
            "logSourceId":"Logs",
            "traceSourceId":"Traces",
            "metricSourceId":"Metrics"
          }
        ]
    ports:
      - "${HYPERDX_API_PORT}:${HYPERDX_API_PORT}"
      - "${HYPERDX_APP_PORT}:${HYPERDX_APP_PORT}"
    networks:
      - clickstack
    depends_on:
      ch-server:
        condition: service_healthy
      db:
        condition: service_healthy

networks:
  clickstack:
    driver: bridge
